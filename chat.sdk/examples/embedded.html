<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>חשב צ'אט - דוגמה מוטמעת</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      margin-bottom: 20px;
      color: #333;
    }

    h3 {
      margin-bottom: 10px;
      color: #444;
      font-size: 14px;
    }

    .content {
      display: flex;
      gap: 20px;
    }

    .context-panel {
      width: 350px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-height: 700px;
      overflow-y: auto;
    }

    .context-section {
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 15px;
    }

    .context-section:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .chat-sidebar {
      height: 550px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* File Picker */
    .file-input-wrapper {
      position: relative;
      display: inline-block;
      width: 100%;
    }

    .file-input {
      display: none;
    }

    .file-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      background-color: #f0f7ff;
      border: 2px dashed #0066cc;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      color: #0066cc;
    }

    .file-label:hover {
      background-color: #e0f0ff;
      border-color: #0052a3;
    }

    .file-info {
      margin-top: 10px;
      padding: 10px;
      background-color: #f8f8f8;
      border-radius: 6px;
      font-size: 12px;
      display: none;
    }

    .file-info.visible {
      display: block;
    }

    .file-info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .file-info-label {
      color: #666;
    }

    .file-info-value {
      color: #333;
      font-weight: 500;
    }

    .file-clear {
      margin-top: 8px;
      font-size: 12px;
      color: #cc0000;
      cursor: pointer;
      text-decoration: underline;
    }

    /* System Instructions */
    .instructions-textarea {
      width: 100%;
      min-height: 100px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-family: inherit;
      font-size: 13px;
      resize: vertical;
      direction: rtl;
    }

    .instructions-textarea:focus {
      outline: none;
      border-color: #0066cc;
    }

    /* Metadata Editor */
    .metadata-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 10px;
    }

    .metadata-tab {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ddd;
      background: #f5f5f5;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .metadata-tab:first-child {
      border-radius: 6px 0 0 6px;
      border-left: 1px solid #ddd;
    }

    .metadata-tab:last-child {
      border-radius: 0 6px 6px 0;
      border-right: 1px solid #ddd;
    }

    .metadata-tab.active {
      background: #0066cc;
      color: white;
      border-color: #0066cc;
    }

    .metadata-content {
      display: none;
    }

    .metadata-content.active {
      display: block;
    }

    /* Key-Value Table */
    .kv-table {
      width: 100%;
      border-collapse: collapse;
    }

    .kv-table th {
      text-align: right;
      padding: 6px 8px;
      background: #f5f5f5;
      font-size: 12px;
      font-weight: 500;
      border-bottom: 1px solid #ddd;
    }

    .kv-table td {
      padding: 4px;
    }

    .kv-table input {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
    }

    .kv-table input:focus {
      outline: none;
      border-color: #0066cc;
    }

    .kv-delete {
      background: none;
      border: none;
      color: #cc0000;
      cursor: pointer;
      padding: 4px 8px;
      font-size: 14px;
    }

    .kv-add {
      margin-top: 8px;
      padding: 6px 12px;
      font-size: 12px;
      background: #f0f7ff;
      color: #0066cc;
      border: 1px dashed #0066cc;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
    }

    .kv-add:hover {
      background: #e0f0ff;
    }

    /* JSON Textarea */
    .json-textarea {
      width: 100%;
      min-height: 120px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
      resize: vertical;
      direction: ltr;
      text-align: left;
    }

    .json-textarea:focus {
      outline: none;
      border-color: #0066cc;
    }

    .json-textarea.error {
      border-color: #cc0000;
      background-color: #fff5f5;
    }

    .json-error {
      color: #cc0000;
      font-size: 11px;
      margin-top: 4px;
      display: none;
    }

    .json-error.visible {
      display: block;
    }

    /* Buttons */
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s;
    }

    .btn-primary {
      background-color: #0066cc;
      color: white;
    }

    .btn-primary:hover {
      background-color: #0052a3;
    }

    .btn-secondary {
      background-color: #e0e0e0;
      color: #333;
    }

    .btn-secondary:hover {
      background-color: #d0d0d0;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .action-buttons button {
      flex: 1;
      min-width: 100px;
    }

    /* Controls */
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Status */
    .status-bar {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 12px 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .status-text {
      font-size: 13px;
      color: #333;
    }

    .token-usage {
      font-size: 12px;
      color: #666;
      font-family: monospace;
      background: #f5f5f5;
      padding: 6px 12px;
      border-radius: 4px;
    }

    .token-usage strong {
      color: #0066cc;
    }

    .cost-display {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 8px;
      border-top: 1px solid #eee;
      font-size: 12px;
    }

    .cost-breakdown {
      color: #666;
    }

    .cost-total {
      font-family: monospace;
      background: linear-gradient(135deg, #f0f7ff, #e8f5e9);
      padding: 6px 12px;
      border-radius: 4px;
      font-weight: 600;
      color: #2e7d32;
    }

    .cost-total .usd {
      font-size: 14px;
    }

    .model-info {
      font-size: 11px;
      color: #999;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>חשב צ'אט - מצב מוטמע</h1>

    <div class="content">
      <!-- Context Panel -->
      <div class="context-panel">
        <h2 style="font-size: 16px; margin-bottom: 5px;">הגדרות הקשר</h2>

        <!-- File Picker Section -->
        <div class="context-section">
          <h3>קובץ מצורף</h3>
          <div class="file-input-wrapper">
            <input type="file" id="file-input" class="file-input" accept=".txt,.json,.csv,.xml,.md">
            <label for="file-input" class="file-label">
              <span>בחר קובץ...</span>
            </label>
          </div>
          <div class="file-info" id="file-info">
            <div class="file-info-row">
              <span class="file-info-label">שם:</span>
              <span class="file-info-value" id="file-name">-</span>
            </div>
            <div class="file-info-row">
              <span class="file-info-label">גודל:</span>
              <span class="file-info-value" id="file-size">-</span>
            </div>
            <div class="file-clear" id="file-clear" onclick="clearFile()">נקה קובץ</div>
          </div>
          <div class="action-buttons" style="margin-top: 10px;">
            <button class="btn-primary btn-small" onclick="loadFile()" id="load-file-btn" disabled>טען קובץ</button>
          </div>
        </div>

        <!-- System Instructions Section -->
        <div class="context-section">
          <h3>הוראות מערכת</h3>
          <textarea class="instructions-textarea" id="instructions-input" placeholder="הזן הוראות מערכת מותאמות אישית...">אתה רואה חשבון מקצועי.
ענה על שאלות בעברית בלבד.
ענה רק על סמך המידע מהקובץ המצורף והמידע הנוסף שסופק.
אם התשובה לא נמצאת במידע שסופק, אמור זאת בבירור.</textarea>
          <div class="action-buttons" style="margin-top: 10px;">
            <button class="btn-primary btn-small" onclick="loadInstructions()">החל הוראות</button>
          </div>
        </div>

        <!-- Metadata Section -->
        <div class="context-section">
          <h3>מידע נוסף (JSON)</h3>
          <div class="metadata-tabs">
            <button class="metadata-tab active" onclick="switchMetadataTab('form')">טופס</button>
            <button class="metadata-tab" onclick="switchMetadataTab('json')">JSON גולמי</button>
          </div>

          <!-- Key-Value Form -->
          <div class="metadata-content active" id="metadata-form">
            <table class="kv-table" id="kv-table">
              <thead>
                <tr>
                  <th style="width: 35%;">מפתח</th>
                  <th style="width: 55%;">ערך</th>
                  <th style="width: 10%;"></th>
                </tr>
              </thead>
              <tbody id="kv-tbody">
                <!-- Rows added dynamically -->
              </tbody>
            </table>
            <button class="kv-add" onclick="addKvRow()">+ הוסף שורה</button>
          </div>

          <!-- Raw JSON -->
          <div class="metadata-content" id="metadata-json">
            <textarea class="json-textarea" id="json-input" placeholder='{
  "key": "value"
}'>{}</textarea>
            <div class="json-error" id="json-error">JSON לא תקין</div>
          </div>

          <div class="action-buttons" style="margin-top: 10px;">
            <button class="btn-primary btn-small" onclick="loadMetadata()">טען מידע נוסף</button>
            <button class="btn-secondary btn-small" onclick="loadMetadataMerge()">מזג</button>
          </div>
        </div>
      </div>

      <!-- Chat Area -->
      <div class="chat-area">
        <div class="chat-sidebar" id="chat-container"></div>

        <div class="controls">
          <button class="btn-secondary" onclick="newConversation()">שיחה חדשה</button>
          <button class="btn-secondary" onclick="resetChat()">אפס</button>
          <button class="btn-secondary" onclick="exportChat()">ייצא</button>
          <button class="btn-secondary" onclick="saveState()">שמור מצב</button>
          <button class="btn-secondary" onclick="loadSavedState()">טען מצב</button>
        </div>

        <div class="status-bar">
          <div class="status-row">
            <span class="status-text" id="status">סטטוס: מאתחל...</span>
            <span class="token-usage" id="token-usage">
              טוקנים: <strong>0</strong> (קלט: 0, פלט: 0)
            </span>
          </div>
          <div class="cost-display">
            <span class="cost-breakdown" id="cost-breakdown">
              <span class="model-info">Gemini 2.5 Pro</span> ·
              קלט: $0.0000 · פלט: $0.0000
            </span>
            <span class="cost-total">
              סה"כ: <span class="usd" id="cost-total">$0.0000</span>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Load the SDK bundle -->
  <script src="../dist/heshev-chat.umd.js"></script>

  <script>
    let chat;
    let savedState = null;
    let fileContent = null;
    let fileName = null;

    // Gemini 2.5 Pro pricing (USD per 1M tokens)
    // Source: https://ai.google.dev/pricing
    const MODEL_PRICING = {
      name: 'Gemini 2.5 Pro',
      inputPer1M: 1.25,   // $1.25 per 1M input tokens
      outputPer1M: 10.00, // $10.00 per 1M output tokens (thinking included)
    };

    function calculateCost(promptTokens, completionTokens) {
      const inputCost = (promptTokens / 1_000_000) * MODEL_PRICING.inputPer1M;
      const outputCost = (completionTokens / 1_000_000) * MODEL_PRICING.outputPer1M;
      return {
        input: inputCost,
        output: outputCost,
        total: inputCost + outputCost,
      };
    }

    function formatCost(cost) {
      if (cost < 0.0001) return '$0.0000';
      if (cost < 0.01) return '$' + cost.toFixed(4);
      return '$' + cost.toFixed(4);
    }

    // Get WebSocket URL from query param (?ws=...) or default
    const params = new URLSearchParams(window.location.search);
    const wsUrl = params.get('ws') || 'ws://172.25.119.147:3001/ws';

    // Initialize the chat
    async function initChat() {
      try {
        chat = new HeshevChat({
          websocketUrl: wsUrl,
          mode: 'embedded',
          container: '#chat-container',
          rtl: true,
          theme: 'light',
          texts: {
            title: 'צ\'אט',
            placeholder: 'הקלד הודעה...',
            placeholderConnecting: 'מתחבר...',
            placeholderLoading: 'טוען...',
            emptyStateTitle: 'אין הודעות עדיין',
            emptyStateSubtitle: 'התחל שיחה!',
            statusConnected: 'מחובר',
            statusConnecting: 'מתחבר...',
            statusDisconnected: 'מנותק',
            statusError: 'שגיאה',
            processing: 'מעבד...',
            closeButton: 'סגור צ\'אט',
          },
          onReady: () => {
            updateStatus('מוכן');
          },
          onStatusChange: (status) => {
            const statusMap = {
              'connected': 'מחובר',
              'connecting': 'מתחבר...',
              'disconnected': 'מנותק',
              'error': 'שגיאה'
            };
            updateStatus(`חיבור: ${statusMap[status] || status}`);
          },
          onMessage: (message) => {
            console.log('הודעה חדשה:', message);
            updateTokenUsage();
          },
          onError: (error) => {
            updateStatus(`שגיאה: ${error.message}`);
          },
        });

        await chat.init();
        updateStatus('מחובר - מוכן לשימוש');
      } catch (error) {
        updateStatus(`אתחול נכשל: ${error.message}`);
      }
    }

    function updateStatus(message) {
      document.getElementById('status').textContent = `סטטוס: ${message}`;
    }

    function updateTokenUsage() {
      if (!chat) return;
      const usage = chat.getTokenUsage();
      const cost = calculateCost(usage.prompt, usage.completion);

      document.getElementById('token-usage').innerHTML =
        `טוקנים: <strong>${usage.total.toLocaleString()}</strong> (קלט: ${usage.prompt.toLocaleString()}, פלט: ${usage.completion.toLocaleString()})`;

      document.getElementById('cost-breakdown').innerHTML =
        `<span class="model-info">${MODEL_PRICING.name}</span> · ` +
        `קלט: ${formatCost(cost.input)} · פלט: ${formatCost(cost.output)}`;

      document.getElementById('cost-total').textContent = formatCost(cost.total);
    }

    // File handling
    document.getElementById('file-input').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(event) {
        fileContent = event.target.result;
        fileName = file.name;

        document.getElementById('file-name').textContent = file.name;
        document.getElementById('file-size').textContent = formatFileSize(file.size);
        document.getElementById('file-info').classList.add('visible');
        document.getElementById('load-file-btn').disabled = false;
      };
      reader.readAsText(file);
    });

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function clearFile() {
      fileContent = null;
      fileName = null;
      document.getElementById('file-input').value = '';
      document.getElementById('file-info').classList.remove('visible');
      document.getElementById('load-file-btn').disabled = true;
    }

    async function loadFile() {
      if (!fileContent) {
        alert('נא לבחור קובץ תחילה');
        return;
      }
      try {
        updateStatus('טוען קובץ...');
        await chat.loadFile(fileContent, fileName);
        updateStatus('הקובץ נטען בהצלחה');
      } catch (error) {
        updateStatus(`טעינת הקובץ נכשלה: ${error.message}`);
      }
    }

    // Instructions handling
    async function loadInstructions() {
      const instructions = document.getElementById('instructions-input').value.trim();
      if (!instructions) {
        alert('נא להזין הוראות מערכת');
        return;
      }
      try {
        updateStatus('מחיל הוראות...');
        await chat.setSystemInstructions(instructions);
        updateStatus('ההוראות הוחלו בהצלחה');
      } catch (error) {
        updateStatus(`החלת ההוראות נכשלה: ${error.message}`);
      }
    }

    // Metadata handling
    function switchMetadataTab(tab) {
      const tabs = document.querySelectorAll('.metadata-tab');
      const contents = document.querySelectorAll('.metadata-content');

      tabs.forEach(t => t.classList.remove('active'));
      contents.forEach(c => c.classList.remove('active'));

      if (tab === 'form') {
        tabs[0].classList.add('active');
        document.getElementById('metadata-form').classList.add('active');
        // Sync JSON to form
        syncJsonToForm();
      } else {
        tabs[1].classList.add('active');
        document.getElementById('metadata-json').classList.add('active');
        // Sync form to JSON
        syncFormToJson();
      }
    }

    function addKvRow(key = '', value = '') {
      const tbody = document.getElementById('kv-tbody');
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><input type="text" placeholder="מפתח" value="${escapeHtml(key)}" onchange="syncFormToJson()"></td>
        <td><input type="text" placeholder="ערך" value="${escapeHtml(value)}" onchange="syncFormToJson()"></td>
        <td><button class="kv-delete" onclick="deleteKvRow(this)">×</button></td>
      `;
      tbody.appendChild(row);
    }

    function deleteKvRow(btn) {
      btn.closest('tr').remove();
      syncFormToJson();
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function getFormData() {
      const rows = document.querySelectorAll('#kv-tbody tr');
      const data = {};
      rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        const key = inputs[0].value.trim();
        const value = inputs[1].value.trim();
        if (key) {
          // Try to parse value as JSON for complex types
          try {
            data[key] = JSON.parse(value);
          } catch {
            data[key] = value;
          }
        }
      });
      return data;
    }

    function syncFormToJson() {
      const data = getFormData();
      const jsonInput = document.getElementById('json-input');
      jsonInput.value = JSON.stringify(data, null, 2);
      jsonInput.classList.remove('error');
      document.getElementById('json-error').classList.remove('visible');
    }

    function syncJsonToForm() {
      const jsonInput = document.getElementById('json-input');
      const tbody = document.getElementById('kv-tbody');

      try {
        const data = JSON.parse(jsonInput.value || '{}');
        jsonInput.classList.remove('error');
        document.getElementById('json-error').classList.remove('visible');

        // Clear existing rows
        tbody.innerHTML = '';

        // Add rows for each key-value pair
        Object.entries(data).forEach(([key, value]) => {
          const valueStr = typeof value === 'object' ? JSON.stringify(value) : String(value);
          addKvRow(key, valueStr);
        });
      } catch (e) {
        jsonInput.classList.add('error');
        document.getElementById('json-error').classList.add('visible');
      }
    }

    // Validate JSON on input
    document.getElementById('json-input').addEventListener('blur', function() {
      try {
        JSON.parse(this.value || '{}');
        this.classList.remove('error');
        document.getElementById('json-error').classList.remove('visible');
      } catch {
        this.classList.add('error');
        document.getElementById('json-error').classList.add('visible');
      }
    });

    function getMetadata() {
      // Check which tab is active
      const isFormActive = document.getElementById('metadata-form').classList.contains('active');

      if (isFormActive) {
        return getFormData();
      } else {
        const jsonInput = document.getElementById('json-input');
        try {
          return JSON.parse(jsonInput.value || '{}');
        } catch {
          alert('JSON לא תקין');
          return null;
        }
      }
    }

    async function loadMetadata() {
      const data = getMetadata();
      if (data === null) return;
      if (Object.keys(data).length === 0) {
        alert('נא להזין מידע נוסף');
        return;
      }

      try {
        updateStatus('טוען מידע נוסף...');
        await chat.loadMetadata(data, false);
        updateStatus('המידע הנוסף נטען בהצלחה');
      } catch (error) {
        updateStatus(`טעינת המידע נכשלה: ${error.message}`);
      }
    }

    async function loadMetadataMerge() {
      const data = getMetadata();
      if (data === null) return;
      if (Object.keys(data).length === 0) {
        alert('נא להזין מידע נוסף');
        return;
      }

      try {
        updateStatus('ממזג מידע נוסף...');
        await chat.loadMetadata(data, true);
        updateStatus('המידע הנוסף מוזג בהצלחה');
      } catch (error) {
        updateStatus(`מיזוג המידע נכשל: ${error.message}`);
      }
    }

    // Chat controls
    function newConversation() {
      chat.new();
      updateStatus('שיחה חדשה החלה');
    }

    function resetChat() {
      chat.reset();
      updateTokenUsage();
      updateStatus('הצ\'אט אופס');
    }

    function exportChat() {
      const data = chat.export();
      console.log('נתונים מיוצאים:', data);
      alert(`יוצאו ${data.messages.length} הודעות\nסה"כ טוקנים: ${data.tokenUsage.total}`);
    }

    function saveState() {
      savedState = chat.saveState();
      console.log('מצב נשמר:', savedState);
      updateStatus('המצב נשמר');
    }

    function loadSavedState() {
      if (savedState) {
        chat.loadState(savedState);
        updateTokenUsage();
        updateStatus('המצב נטען');
      } else {
        alert('אין מצב שמור זמין');
      }
    }

    // Initialize on page load
    initChat();
  </script>
</body>
</html>
